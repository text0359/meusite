<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enchanted Pink Cinema Room</title>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js" onerror="handleScriptError('PeerJS')"></script>
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js" onerror="handleScriptError('Particles.js')"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Estilos Gerais para o Corpo */
    body {
      background: linear-gradient(135deg, #f9a8d4, #f472b6, #ec4899);
      font-family: 'Arial', sans-serif;
      overflow-x: hidden; /* CR√çTICO: Evita rolagem horizontal em qualquer cen√°rio */
      animation: gradientShift 15s ease infinite;
      padding: 0; /* REMOVIDO padding padr√£o do body */
    }
    /* Anima√ß√£o de Fundo Gradiente */
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    /* Cont√™iner Principal da Sala de Cinema */
    .cinema-container {
      background-color: rgba(255, 182, 193, 0.95);
      border-radius: 20px;
      padding: 20px; /* Padding padr√£o */
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transform: translateY(20px);
      animation: floatIn 1s ease-out forwards;
      /* Ajustes de responsividade aprimorados */
      width: 100%; /* Agora ocupa 100% da largura do body */
      max-width: 900px; /* Limite em telas maiores para n√£o esticar demais */
      margin: 0 auto; /* Centraliza o container horizontalmente, sem margem vertical padr√£o */
      box-sizing: border-box; /* Garante que padding n√£o cause overflow */
    }
    /* Anima√ß√£o de Entrada do Cont√™iner */
    @keyframes floatIn {
      to { transform: translateY(0); opacity: 1; }
    }
    /* Estilo do Player de V√≠deo */
    video {
      border: 4px solid #ec4899;
      border-radius: 15px;
      transition: opacity 0.5s ease;
      width: 100%; /* Essencial: O v√≠deo sempre ocupa a largura total do seu cont√™iner */
      height: auto; /* Mant√©m a propor√ß√£o do v√≠deo */
      display: block; /* Remove espa√ßo extra abaixo do v√≠deo */
    }
    /* Estilo dos Bot√µes */
    button {
      background: linear-gradient(45deg, #f472b6, #ec4899);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      border: none;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      overflow: hidden;
      width: 100%; /* Bot√µes sempre ocupam 100% da largura em pequenos dispositivos */
      font-size: 1rem; /* Garante tamanho leg√≠vel */
    }
    button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(236, 72, 153, 0.7);
    }
    button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.4s, height 0.4s;
    }
    button:active::after {
      width: 200px;
      height: 200px;
    }
    /* Estilo da √Årea de Upload de Arquivos */
    .file-upload {
      background-color: #fef2f2;
      border: 3px dashed #f472b6;
      padding: 15px;
      border-radius: 15px;
      transition: transform 0.3s ease;
      box-sizing: border-box; /* Garante que padding n√£o cause overflow */
    }
    .file-upload:hover {
      transform: scale(1.02);
    }
    /* Estilo do Menu Lateral */
    .menu {
      background: rgba(244, 114, 182, 0.9);
      backdrop-filter: blur(10px);
      transition: transform 0.3s ease, opacity 0.3s ease; /* Adicionada transi√ß√£o para opacidade */
      z-index: 100; /* Garante que o menu fique sobre outros elementos */
      width: 80%; /* Ocupa mais largura em celulares para melhor usabilidade */
      max-width: 280px; /* Limita a largura m√°xima em telas maiores */
      box-sizing: border-box; /* Garante que padding n√£o cause overflow */
      padding: 1rem; /* Espa√ßamento interno */
      pointer-events: auto; /* Permite intera√ß√µes quando vis√≠vel */
    }
    .menu-hidden {
      transform: translateX(-150%); /* Aumentada a transla√ß√£o para garantir que suma completamente */
      opacity: 0; /* Torna o menu completamente invis√≠vel */
      pointer-events: none; /* Impede cliques em elementos invis√≠veis */
    }
    /* Estilo dos Itens da Lista de Cenas */
    .scene-item {
      cursor: pointer;
      transition: background-color 0.3s;
      padding: 0.75rem; /* Ajuste para melhor toque */
      border-radius: 8px; /* Cantos arredondados */
    }
    .scene-item:hover {
      background-color: #f9a8d4;
    }
    /* Part√≠culas de Fundo */
    #particles-js {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
    }
    /* Estilos de Status de Conex√£o */
    .status-connected { color: #10b981; }
    .status-error { color: #ef4444; }

    /* NOVO: Estilos para Overlay de Rea√ß√µes */
    #reactionOverlay {
      position: absolute; /* **AGORA ABSOLUTO para ficar dentro do video-player-wrapper** */
      inset: 0; /* Cobre todo o wrapper do v√≠deo */
      z-index: 90; /* Abaixo do menu, mas acima do conte√∫do */
      pointer-events: none; /* N√£o bloqueia intera√ß√£o com a tela */
      overflow: hidden; /* Garante que emojis n√£o saiam da tela se a anima√ß√£o os levar longe */
    }

    .reaction-emoji {
      position: absolute;
      font-size: 3rem; /* Tamanho inicial do emoji */
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.5); /* Centraliza e diminui */
      animation: fade-slide-up 2.5s ease-out forwards; /* Anima√ß√£o */
      text-shadow: 2px 2px 5px rgba(0,0,0,0.3); /* Sombra para destaque */
    }

    /* Anima√ß√£o do Emoji */
    @keyframes fade-slide-up {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5) translateY(50px);
      }
      20% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.1) translateY(0);
      }
      80% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(0.9) translateY(-50px);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.7) translateY(-100px);
      }
    }

    /* NOVO: Estilos para o Wrapper do Player de V√≠deo e Overlays Internos */
    .video-player-wrapper {
      position: relative;
      width: 100%;
      height: auto;
      max-width: 100%;
      overflow: hidden;
      border-radius: 15px; /* Arredondamento igual ao v√≠deo */
      box-shadow: 0 4px 15px rgba(0,0,0,0.2); /* Sombra suave */
      /* Garante que o wrapper tenha altura para o overlay */
      padding-top: 56.25%; /* 16:9 Aspect Ratio (9 / 16 * 100%) */
      background-color: black; /* Fundo para quando n√£o h√° v√≠deo */
    }

    .video-player-wrapper video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain; /* Garante que o v√≠deo se ajuste sem cortar */
    }

    .video-player-overlay {
      position: absolute;
      inset: 0; /* Cobre todo o wrapper do v√≠deo */
      z-index: 10; /* Acima do v√≠deo, abaixo dos controles nativos do navegador */
      pointer-events: none; /* Permite que cliques passem para o v√≠deo por padr√£o, exceto em bot√µes */
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 1rem; /* Padding interno para os bot√µes */
      background-color: rgba(0,0,0,0); /* **Inicia totalmente transparente** */
      opacity: 0; /* **Inicia oculto** */
      transition: background-color 0.3s ease, opacity 0.3s ease;
    }

    /* Efeito de hover no wrapper para escurecer o overlay e mostrar controles */
    .video-player-wrapper:hover .video-player-overlay,
    .video-player-overlay.show-overlay { /* Classe JS para mostrar no touch */
      opacity: 1; /* Totalmente vis√≠vel no hover/touch */
      background-color: rgba(0,0,0,0.15); /* Fundo sutilmente transl√∫cido */
    }

    /* Estilo do bot√£o central de Play/Pause */
    #overlayPlayPauseButton {
      pointer-events: auto; /* Torna o bot√£o clic√°vel */
      background-color: rgba(236, 72, 153, 0.7); /* Rosa com transpar√™ncia */
      color: white;
      border-radius: 9999px; /* C√≠rculo completo */
      padding: 1rem;
      font-size: 3rem; /* √çcone grande */
      opacity: 0; /* **Inicia oculto** */
      transition: opacity 0.3s ease, background-color 0.2s ease;
      flex-shrink: 0; /* Evita encolhimento */
      display: flex;
      align-items: center;
      justify-content: center;
      width: 80px; /* Tamanho fixo */
      height: 80px; /* Tamanho fixo */
      margin: auto; /* Centraliza horizontal e verticalmente */
    }

    /* Mostrar o bot√£o de play/pause no hover, ou se estiver pausado, ou se a classe 'show-button' estiver ativa */
    .video-player-wrapper:hover #overlayPlayPauseButton,
    #overlayPlayPauseButton.is-paused, /* **Sempre vis√≠vel quando pausado** */
    #overlayPlayPauseButton.show-button { /* **Vis√≠vel por um tempo no touch** */
      opacity: 0.9; /* Um pouco transparente */
    }

    #overlayPlayPauseButton:hover {
      opacity: 1; /* Totalmente opaco no hover direto no bot√£o */
      background-color: rgba(236, 72, 153, 1);
    }

    /* Estilo dos bot√µes de rea√ß√£o dentro do v√≠deo */
    .reaction-buttons-in-video {
        display: flex;
        justify-content: flex-end; /* Alinha √† direita */
        align-items: flex-end; /* Alinha √† parte inferior */
        gap: 0.5rem; /* Espa√ßamento entre bot√µes */
        pointer-events: auto; /* Permite clicar nos bot√µes */
        opacity: 0; /* **Inicia oculto** */
        transition: opacity 0.3s ease;
        padding-bottom: 0.5rem; /* Espa√ßo na parte inferior para n√£o colar na borda */
    }

    .video-player-wrapper:hover .reaction-buttons-in-video,
    .reaction-buttons-in-video.show-buttons { /* Classe JS para mostrar no touch */
        opacity: 0.8; /* **Vis√≠vel com transpar√™ncia no hover/touch** */
    }

    .reaction-buttons-in-video button {
      background: linear-gradient(45deg, #f472b6, #ec4899); /* **Bot√µes de rea√ß√£o usam o mesmo gradiente dos outros** */
      color: white;
      border-radius: 9999px; /* C√≠rculo completo */
      padding: 0.5rem;
      font-size: 1.5rem; /* Tamanho do emoji */
      transition: opacity 0.2s ease, background-color 0.2s ease;
      width: 50px; /* Tamanho fixo para facilitar o toque */
      height: 50px; /* Tamanho fixo */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .reaction-buttons-in-video button:hover {
      opacity: 1; /* Totalmente opaco no hover direto no bot√£o */
      background-color: rgba(236, 72, 153, 1);
    }

    /* NOVO: Estilos da Tela de Introdu√ß√£o */
    #introScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg, #a020f0, #d8bfd8, #ff69b4); /* Gradiente roxo-rosa */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 200; /* Acima de tudo */
        color: white;
        text-shadow: 0 0 10px rgba(0,0,0,0.5);
        transition: opacity 1s ease-out; /* Transi√ß√£o de fade-out */
        opacity: 1;
    }

    #introScreen.fade-out {
        opacity: 0;
        pointer-events: none; /* Impede cliques ap√≥s fade-out */
    }

    #introTitle {
        font-family: 'Times New Roman', serif; /* Fonte cl√°ssica de cinema */
        font-size: 3rem; /* Tamanho grande */
        font-weight: bold;
        margin-bottom: 2rem;
        text-align: center;
        padding: 0 1rem;
        /* NOVO: Anima√ß√£o de entrada e depois o brilho */
        animation: fadeInScale 1s ease-out forwards, neonGlow 1.5s ease-in-out infinite alternate 1s;
    }

    /* NOVO: Anima√ß√£o de Fade-in e Escala para elementos da introdu√ß√£o */
    @keyframes fadeInScale {
        0% { opacity: 0; transform: scale(0.8); }
        100% { opacity: 1; transform: scale(1); }
    }

    @keyframes neonGlow {
        from { text-shadow: 0 0 5px #fff, 0 0 10px #ff69b4, 0 0 20px #ff69b4, 0 0 30px #ff69b4; }
        to { text-shadow: 0 0 10px #fff, 0 0 20px #ff69b4, 0 0 30px #ff69b4, 0 0 40px #ff69b4; }
    }

    #introVideoContainer {
        width: 80%; /* Tamanho do mini-filme */
        max-width: 600px;
        border: 5px solid #ff69b4;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 2rem;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        /* NOVO: Anima√ß√£o de entrada e brilho na borda */
        animation: fadeInScale 1.5s ease-out forwards, borderGlow 2s ease-in-out infinite alternate;
    }

    /* NOVO: Anima√ß√£o para o brilho da borda do v√≠deo */
    @keyframes borderGlow {
        from { border-color: #ff69b4; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        to { border-color: #f9a8d4; box-shadow: 0 0 30px #f9a8d4, 0 0 40px #ff69b4; }
    }


    #introVideo {
        width: 100%;
        height: auto;
        display: block;
    }

    #loadingBarContainer {
        width: 70%;
        max-width: 400px;
        background-color: rgba(255,255,255,0.3);
        border-radius: 5px;
        height: 10px;
        overflow: hidden;
        margin-top: 1rem;
    }

    #loadingBar {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #f472b6, #ec4899); /* Barra rosa/dourada */
        animation: loadingFill 12s linear forwards; /* Anima√ß√£o de preenchimento */
    }

    @keyframes loadingFill {
        from { width: 0%; }
        to { width: 100%; }
    }

    #loadingText {
        margin-top: 0.5rem;
        font-size: 1.2rem;
        color: #f9a8d4;
    }
    
    /* NOVO: Estilo para o bot√£o de in√≠cio na intro screen */
    #startButton {
        background: linear-gradient(45deg, #a020f0, #ff69b4);
        color: white;
        padding: 15px 30px;
        border-radius: 15px;
        border: none;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        margin-top: 2rem; /* Espa√ßamento do loading bar */
    }
    #startButton:hover {
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(255,105,180,0.7);
    }

    /* Custom Fullscreen Mode */
    .video-player-wrapper.custom-fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 1000; /* Above all other content */
        border-radius: 0; /* No rounded corners in fullscreen */
        padding-top: 0; /* No aspect ratio padding in fullscreen */
        box-shadow: none;
    }

    .video-player-wrapper.custom-fullscreen video {
        object-fit: contain; /* Ensure video fits within screen */
    }
    /* Ensure the controls are always visible in custom fullscreen */
    .video-player-wrapper.custom-fullscreen .video-player-overlay {
        opacity: 1;
        background-color: rgba(0,0,0,0.15); /* Slightly visible overlay */
    }
    .video-player-wrapper.custom-fullscreen #overlayPlayPauseButton,
    .video-player-wrapper.custom-fullscreen .reaction-buttons-in-video {
        opacity: 0.9; /* Slightly visible controls */
    }

    /* Hide native controls when in custom fullscreen */
    .video-player-wrapper.custom-fullscreen video::-webkit-media-controls-enclosure {
        display: none !important;
    }
    /* Para Firefox */
    .video-player-wrapper.custom-fullscreen video::-moz-media-controls {
        display: none !important;
    }
    /* Para Edge/IE */
    .video-player-wrapper.custom-fullscreen video::-ms-media-controls {
        display: none !important;
    }
    /* Gen√©rico - pode n√£o funcionar em todos os browsers */
    .video-player-wrapper.custom-fullscreen video::media-controls-container {
        display: none !important;
    }


    /* Media Queries para Ajustes Mais Finos em Telas de Celular */
    @media (max-width: 768px) { /* Para tablets e celulares */
      .cinema-container {
        padding: 15px; /* Reduz o padding geral para economizar espa√ßo */
        border-radius: 15px; /* Ajusta o raio da borda */
      }
      h1 {
        font-size: 2rem; /* T√≠tulos menores para caber melhor */
        margin-bottom: 1rem;
      }
      button {
        padding: 10px 15px; /* Bot√µes um pouco menores */
        margin-bottom: 0.75rem; /* Espa√ßamento entre bot√µes */
      }
      .flex-col-mobile { /* Usado para for√ßar empilhamento de bot√µes, se necess√°rio */
        flex-direction: column;
      }
      .input-full-width { /* Garante inputs que ocupam toda a largura */
        width: 100%;
        box-sizing: border-box;
      }
      .space-y-2 > *:not([hidden]) ~ *:not([hidden]) {
        margin-top: 0.5rem; /* Ajusta espa√ßamento vertical para elementos empilhados */
      }
      .reaction-emoji {
        font-size: 2.5rem; /* Menor em telas menores */
      }
      /* Ajustes para bot√µes no v√≠deo em telas menores */
      #overlayPlayPauseButton {
        font-size: 2.5rem;
        width: 60px;
        height: 60px;
      }
      .reaction-buttons-in-video button {
        font-size: 1.25rem;
        width: 40px;
        height: 40px;
      }
      .reaction-buttons-in-video {
        gap: 0.3rem; /* Menor espa√ßamento entre bot√µes em telas pequenas */
      }

      #introTitle {
          font-size: 2.5rem;
      }
      #introVideoContainer {
          width: 90%;
      }
      #loadingBarContainer {
          width: 80%;
      }
      #loadingText {
          font-size: 1rem;
      }
      #startButton {
          font-size: 1.2rem;
          padding: 12px 25px;
      }
    }

    @media (max-width: 480px) { /* Para celulares muito pequenos */
      .cinema-container {
        padding: 10px;
        border-radius: 10px; /* Cantos um pouco menos arredondados para economizar espa√ßo */
      }
      h1 {
        font-size: 1.75rem; /* T√≠tulos ainda menores */
      }
      button {
        font-size: 0.9rem;
        padding: 8px 12px;
        border-radius: 10px;
      }
      .menu {
        width: 90%; /* Menu ainda maior em telas muito pequenas */
      }
      .file-upload {
        padding: 10px;
      }
      .reaction-emoji {
        font-size: 2rem; /* Ainda menor em telas muito pequenas */
      }
      /* Ajustes para bot√µes no v√≠deo em telas muito pequenas */
      #overlayPlayPauseButton {
        font-size: 2rem;
        width: 50px;
        height: 50px;
      }
      .reaction-buttons-in-video button {
        font-size: 1rem;
        width: 35px;
        height: 35px;
      }

      #introTitle {
          font-size: 1.8rem;
      }
      #introVideoContainer {
          width: 95%;
      }
      #loadingBarContainer {
          width: 90%;
      }
      #loadingText {
          font-size: 0.9rem;
      }
      #startButton {
          font-size: 1rem;
          padding: 10px 20px;
      }
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen">
  <div id="particles-js"></div>
  
  <div id="introScreen">
    <h1 id="introTitle">Werveson & Leticia's Home Cinema</h1>
    <div id="introVideoContainer">
        <video id="introVideo" loop muted playsinline>
            <source src="https://www.learningcontainer.com/wp-content/uploads/2020/05/sample-mp4-file.mp4" type="video/mp4">
            Seu navegador n√£o suporta a tag de v√≠deo.
        </video>
    </div>
    <p id="loadingText">Carregando a experi√™ncia...</p>
    <div id="loadingBarContainer">
        <div id="loadingBar"></div>
    </div>
    <button id="startButton" onclick="startCinemaExperience(true)">Iniciar Cinema</button>
  </div>

  <audio id="clickSound1" src="https://freesound.org/data/previews/171/171671_2437358-lq.mp3" onerror="handleAudioError('Click Sound 1')"></audio>
  <audio id="clickSound2" src="https://freesound.org/data/previews/171/171668_2437358-lq.mp3" onerror="handleAudioError('Click Sound 2')"></audio>
  <audio id="clickSound3" src="https://freesound.org/data/previews/171/171670_2437358-lq.mp3" onerror="handleAudioError('Click Sound 3')"></audio>

  <audio id="bgMusic" src="https://freesound.org/data/previews/235/235655_4229646-lq.mp3" loop muted onerror="handleAudioError('Background Music')"></audio>

  <div class="cinema-container w-full sm:max-w-xl md:max-w-3xl lg:max-w-5xl xl:max-w-6xl mx-auto relative flex flex-col items-center p-4 hidden">
    <h1 class="text-3xl sm:text-4xl font-bold text-pink-800 text-center mb-6 sm:mb-8 animate-pulse mt-4">
      Enchanted Pink Cinema Room
    </h1>
    
    <button onclick="toggleMenu()" class="absolute top-4 left-4 z-50 px-4 py-2 text-white rounded-lg text-sm sm:text-base">
      Menu
    </button>

    <div id="menu" class="menu fixed top-0 left-0 h-full w-3/4 sm:w-64 p-4 menu-hidden shadow-lg">
      <h2 class="text-2xl text-pink-800 mb-4">Menu</h2>
      <button onclick="toggleMenu()" class="mb-4">Fechar Menu</button>
      <div class="space-y-3 mt-4">
        <button onclick="uploadAndShareFile()">Carregar & Transmitir V√≠deo</button>
        <button onclick="syncPlay()">Sincronizar Play</button>
        <button onclick="syncPause()">Sincronizar Pausar</button>
        <button onclick="addScene()">Adicionar Cena</button>
      </div>
      <h3 class="text-xl text-pink-700 mt-6 mb-2">Cenas</h3>
      <ul id="sceneList" class="text-pink-800 space-y-2 max-h-48 overflow-y-auto"></ul>
    </div>
    
    <div class="w-full mb-6 text-center fade-in px-4">
      <h2 class="text-xl text-pink-700 mb-2">Conectar com Amigo</h2>
      <p class="text-pink-800 mb-2">Seu Peer ID: <span id="myPeerId" class="font-bold"></span></p>
      <p id="connectionStatus" class="text-pink-800 mb-2">Status: Desconectado</p>
      <input id="remotePeerId" type="text" placeholder="Insira o Peer ID do amigo" 
             class="w-full p-2 mb-4 text-pink-800 border border-pink-700 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent text-base">
      <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-2">
        <button onclick="connectToPeer()" class="text-base">Conectar</button>
        <button onclick="retryConnection()" class="text-base">Tentar Novamente</button>
      </div>
    </div>
    
    <div class="w-full mb-6 fade-in px-4">
      <h2 class="text-xl text-pink-700 mb-2">Player de Filme</h2>
      <div class="video-player-wrapper">
        <video id="moviePlayer" controls class="w-full h-auto block bg-black">
          <source id="movieSource" src="" type="video/mp4">
          Seu navegador n√£o suporta a tag de v√≠deo.
        </video>

        <div id="reactionOverlay" class="absolute inset-0 pointer-events-none overflow-hidden"></div>

        <div id="videoOverlayControls" class="video-player-overlay">
          <div class="flex flex-grow items-center justify-center">
              <button id="overlayPlayPauseButton" onclick="toggleOverlayPlayPause()">
                  <span id="overlayPlayIcon">‚ñ∂Ô∏è</span>
                  <span id="overlayPauseIcon" class="hidden">‚è∏Ô∏è</span>
              </button>
          </div>

          <div class="flex justify-end items-end gap-2 p-2 w-full"> 
              <div id="reactionButtonsInVideo" class="flex justify-end gap-2 reaction-buttons-in-video">
                  <button onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                  <button onclick="sendReaction('üòÇ')">üòÇ</button>
                  <button onclick="sendReaction('‚úã')">‚úã</button>
                  <button onclick="sendReaction('üòÆ')">üòÆ</button>
                  <button onclick="sendReaction('üò¢')">üò¢</button>
                  <button onclick="sendReaction('‚ú®')">‚ú®</button>
              </div>
              <button id="customFullscreenButton" onclick="toggleCustomFullscreen()" class="ml-2 bg-pink-600 hover:bg-pink-700 p-2 rounded-lg text-lg">
                  ‚ÜîÔ∏è
              </button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="file-upload w-full mb-6 fade-in px-4">
      <h2 class="text-xl text-pink-700 mb-2">Carregar um Filme/V√≠deo</h2>
      <input type="file" id="fileInput" accept="video/*" class="mb-4 text-pink-800 w-full text-base">
      <button onclick="uploadAndShareFile()" class="text-base">Carregar & Transmitir V√≠deo</button>
      
      <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-2 mt-2">
        <button onclick="shareFileForDownload()" class="text-base">Enviar Arquivo para Download</button>
        <button id="cancelDownloadButton" onclick="cancelFileDownload()" class="text-base bg-red-500 hover:bg-red-600 hidden">Cancelar Download</button>
      </div>

      <div id="downloadSection" class="mt-4 text-center"></div>
      <p id="streamingStatus" class="w-full mt-4 text-center text-pink-800 font-semibold text-sm sm:text-base hidden"></p>
      <p id="downloadProgressStatus" class="w-full mt-4 text-center text-pink-800 font-semibold text-sm sm:text-base hidden"></p>
      
      <p class="text-xs text-pink-700 mt-2">
        A velocidade do download Peer-to-Peer depende da sua conex√£o e da do seu amigo. <br>
        Para compartilhar links p√∫blicos ou downloads mais r√°pidos de arquivos grandes, um servidor externo seria necess√°rio.
      </p>
    </div>

  </div>

  <script>
    // Vari√°veis globais para PeerJS e elementos do DOM
    let peer;
    let conn;
    let currentFileUrl = null;
    let scenes = [];
    const moviePlayer = document.getElementById('moviePlayer');
    const movieSource = document.getElementById('movieSource');
    const fileInput = document.getElementById('fileInput');
    const downloadSection = document.getElementById('downloadSection');
    const myPeerIdDisplay = document.getElementById('myPeerId');
    const remotePeerIdInput = document.getElementById('remotePeerId');
    const connectionStatus = document.getElementById('connectionStatus');
    const sceneList = document.getElementById('sceneList');
    
    // Array de URLs de sons de clique para variedade
    const clickSounds = [
      new Audio("https://freesound.org/data/previews/171/171671_2437358-lq.mp3"), // Click original
      new Audio("https://freesound.org/data/previews/171/171668_2437358-lq.mp3"), // Click 2
      new Audio("https://freesound.org/data/previews/171/171670_2437358-lq.mp3")  // Click 3
    ];
    clickSounds.forEach(s => s.volume = 0.1); // Reduz o volume dos sons de clique
    
    const bgMusic = document.getElementById('bgMusic');
    const reactionOverlay = document.getElementById('reactionOverlay'); 
    // Vari√°veis para controle de download
    let receivedFiles = new Map(); 
    let currentFileReader = null; 
    let currentFileTransferId = null; 

    let isSyncing = false;

    // Elementos do overlay de play/pause
    const overlayPlayPauseButton = document.getElementById('overlayPlayPauseButton');
    const overlayPlayIcon = document.getElementById('overlayPlayIcon');
    const overlayPauseIcon = document.getElementById('overlayPauseIcon');
    const videoPlayerWrapper = document.querySelector('.video-player-wrapper'); 
    const videoOverlayControls = document.getElementById('videoOverlayControls'); 
    const reactionButtonsInVideo = document.getElementById('reactionButtonsInVideo'); 

    // Elementos da Tela de Introdu√ß√£o
    const introScreen = document.getElementById('introScreen');
    const introVideo = document.getElementById('introVideo');
    const cinemaContainer = document.querySelector('.cinema-container');
    const loadingBar = document.getElementById('loadingBar'); // Refer√™ncia √† barra de carregamento
    const loadingText = document.getElementById('loadingText'); // Refer√™ncia ao texto de carregamento
    const customFullscreenButton = document.getElementById('customFullscreenButton'); // Bot√£o de tela cheia customizada
    let isCustomFullscreen = false; // Estado da tela cheia customizada

    // Vari√°vel para o ID do setTimeout da transi√ß√£o da intro
    let introScreenTimeoutId;

    // Fun√ß√µes de tratamento de erro para scripts e √°udios
    function handleScriptError(scriptName) {
      connectionStatus.textContent = `Status: Erro ao carregar ${scriptName}. Por favor, atualize a p√°gina.`;
      connectionStatus.classList.add('status-error');
      console.error(`${scriptName} falhou ao carregar`);
    }

    function handleAudioError(audioName) {
      console.warn(`${audioName} falhou ao carregar. Considere hospedar arquivos de √°udio localmente.`);
    }

    // Inicializa√ß√£o do Particle.js para efeitos visuais
    if (typeof particlesJS !== 'undefined') {
      particlesJS('particles-js', {
        particles: {
          number: { value: 80, density: { enable: true, value_area: 800 } },
          color: { value: '#f9a8d4' },
          shape: { type: 'circle' },
          opacity: { value: 0.5, random: true },
          size: { value: 3, random: true },
          line_linked: { enable: false },
          move: { enable: true, speed: 2, direction: 'none', random: true }
        },
        interactivity: { detect_on: 'canvas', events: { onhover: { enable: true, mode: 'repulse' } } }
      });
    } else {
      console.warn('Particle.js n√£o carregado');
    }

    // Fun√ß√£o para iniciar a experi√™ncia do cinema ap√≥s o clique do usu√°rio ou timeout
    function startCinemaExperience(fromButtonClick = false) {
        // Limpa o setTimeout que faria a transi√ß√£o autom√°tica ap√≥s 12 segundos
        clearTimeout(introScreenTimeoutId);

        // Desmuta e tenta tocar a m√∫sica de fundo (se ainda n√£o estiver tocando)
        bgMusic.muted = false; // Desmuta a m√∫sica
        bgMusic.play().catch(e => {
            console.log("M√∫sica de fundo bloqueada ou falhou ao tocar:", e);
        });

        // Desmuta e tenta tocar o v√≠deo da introdu√ß√£o (se ainda n√£o estiver tocando)
        introVideo.muted = false; // Desmuta o v√≠deo
        introVideo.play().catch(e => console.log("V√≠deo da introdu√ß√£o bloqueado ou falhou ao tocar:", e));

        // Transi√ß√£o da tela de introdu√ß√£o para a sala de cinema principal
        introScreen.classList.add('fade-out');
        
        // Pausar e resetar √°udio/v√≠deo da introdu√ß√£o AP√ìS o fade-out
        setTimeout(() => {
            introScreen.style.display = 'none';
            cinemaContainer.classList.remove('hidden'); // Mostra o cinema container
            cinemaContainer.classList.add('float-in'); // Garante a anima√ß√£o de entrada
            
            // Pausar e resetar o v√≠deo da introdu√ß√£o
            introVideo.pause();
            introVideo.currentTime = 0;
            introVideo.muted = true; // Garante que permane√ßa mutado se iniciado de novo

            // Pausar e resetar a m√∫sica de fundo (RPG)
            bgMusic.pause();
            bgMusic.currentTime = 0;
            bgMusic.muted = true; // Garante que permane√ßa mutada
        }, 1000); // Tempo da transi√ß√£o de fade-out

        // Se a chamada veio do bot√£o, reinicia a anima√ß√£o da barra para 'completar' imediatamente
        if (fromButtonClick) {
            loadingBar.style.animation = 'none'; // Reseta a anima√ß√£o
            void loadingBar.offsetWidth; // Trigger reflow
            loadingBar.style.animation = 'loadingFill 0.5s ease-out forwards'; // Completa rapidamente
            loadingText.textContent = "Iniciando cinema...";
        }
    }

    // Executa a configura√ß√£o inicial da tela de introdu√ß√£o ao carregar a p√°gina
    window.addEventListener('load', () => {
        // Tenta tocar a m√∫sica de fundo (mutada) e o v√≠deo da introdu√ß√£o (mutado)
        // Eles estar√£o mutados para tentar contornar a pol√≠tica de autoplay
        bgMusic.volume = 0.3;
        bgMusic.muted = true; // Garante que comece mutado
        // Tenta tocar, mas pode ser bloqueado pelo navegador at√© a primeira intera√ß√£o
        bgMusic.play().catch(e => console.log("M√∫sica de fundo bloqueada em load (mutada):", e));

        introVideo.muted = true; // Garante que o v√≠deo de introdu√ß√£o comece mutado
        // Tenta tocar, mas pode ser bloqueado pelo navegador at√© a primeira intera√ß√£o
        introVideo.play().catch(e => console.log("V√≠deo da introdu√ß√£o bloqueado em load (mutado):", e));

        // Inicia a anima√ß√£o da barra de carregamento e define o timeout para a transi√ß√£o autom√°tica
        loadingBar.style.animation = 'loadingFill 12s linear forwards';
        loadingText.textContent = "Carregando a experi√™ncia...";

        // Define o timeout para a transi√ß√£o autom√°tica ap√≥s 12 segundos
        introScreenTimeoutId = setTimeout(() => {
            startCinemaExperience(false); // Chama a fun√ß√£o de in√≠cio (n√£o veio de um clique no bot√£o)
        }, 12000); // 12 segundos para a introdu√ß√£o
    });


    // Adiciona som de clique a todos os bot√µes
    document.querySelectorAll('button').forEach(button => {
      button.addEventListener('click', () => {
        // Toca um som de clique aleat√≥rio
        const randomClickSound = clickSounds[Math.floor(Math.random() * clickSounds.length)];
        randomClickSound.currentTime = 0; // Reinicia o som
        randomClickSound.play().catch(() => console.log('Som de clique bloqueado'));
      });
    });

    // Fun√ß√£o para alternar a visibilidade do menu lateral
    function toggleMenu() {
      const menu = document.getElementById('menu');
      menu.classList.toggle('menu-hidden');
    }

    // Inicializa√ß√£o do PeerJS com servidores STUN/TURN para melhor conectividade
    peer = new Peer({
      host: '0.peerjs.com',
      secure: true,
      port: 443,
      config: {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'turn:openrelay.metered.ca:80', username: 'openrelay.project', credential: 'openrelayproject' }
        ]
      }
    });

    // Evento quando o PeerJS √© aberto e recebe um ID
    peer.on('open', (id) => {
      myPeerIdDisplay.textContent = id;
      connectionStatus.textContent = 'Status: Aguardando conex√£o...';
      connectionStatus.classList.remove('status-error', 'status-connected');
      console.log('PeerJS inicializado com ID:', id);
    });

    // Evento para lidar com novas conex√µes recebidas
    peer.on('connection', (connection) => {
      conn = connection;
      setupConnection();
    });

    // Evento para lidar com erros do PeerJS
    peer.on('error', (err) => {
      connectionStatus.textContent = `Status: Erro - ${err.type}. ${err.type === 'peer-unavailable' ? 'Verifique o Peer ID ou garanta que o amigo esteja online.' : 'Erro de rede/servidor. Tentando reconectar...'}`;
      connectionStatus.classList.add('status-error');
      console.error('PeerJS error:', err);

      // Tenta reconectar se a conex√£o com o servidor for perdida
      if (err.type === 'peer-disconnected' || err.type === 'network' || err.type === 'server-disconnected') {
        if (reconnectPeerTimeout) clearTimeout(reconnectPeerTimeout);
        reconnectPeerTimeout = setTimeout(() => {
          console.log('Tentando reconectar ao servidor PeerJS...');
          peer.reconnect(); // O PeerJS tem um m√©todo embutido para reconectar
        }, 5000); // Tenta reconectar ap√≥s 5 segundos
      }
    });

    peer.on('close', () => {
      connectionStatus.textContent = 'Status: Desconectado do servidor. Tentando reconectar...';
      connectionStatus.classList.add('status-error');
      console.log('Conex√£o PeerJS com o servidor fechada.');

      // Agenda a reconex√£o autom√°tica
      if (reconnectPeerTimeout) clearTimeout(reconnectPeerTimeout);
      reconnectPeerTimeout = setTimeout(() => {
        console.log('Tentando reconectar ao servidor PeerJS ap√≥s evento de fechamento...');
        peer.reconnect();
      }, 5000); // Tenta reconectar ap√≥s 5 segundos
    });

    // Fun√ß√£o para iniciar a conex√£o com outro Peer
    function connectToPeer() {
      const remoteId = remotePeerIdInput.value.trim();
      if (remoteId) {
        connectionStatus.textContent = 'Status: Conectando...';
        connectionStatus.classList.remove('status-error', 'status-connected');
        conn = peer.connect(remoteId);
        setupConnection();
      } else {
        connectionStatus.textContent = 'Status: Insira um Peer ID v√°lido';
        connectionStatus.classList.add('status-error');
        console.warn('Nenhum Peer ID inserido');
      }
    }

    // Fun√ß√£o para tentar novamente a conex√£o PeerJS
    function retryConnection() {
      if (remotePeerIdInput.value.trim()) {
        connectionStatus.textContent = 'Status: Tentando novamente a conex√£o...';
        connectionStatus.classList.remove('status-error', 'status-connected');
        peer.destroy(); // Destr√≥i a inst√¢ncia PeerJS atual
        // Cria uma nova inst√¢ncia PeerJS
        peer = new Peer({
          host: '0.peerjs.com',
          secure: true,
          port: 443,
          config: {
            iceServers: [
              { urls: 'stun:stun.l.google.com:19302' },
              { urls: 'turn:openrelay.metered.ca:80', username: 'openrelay.project', credential: 'openrelayproject' }
            ]
          }
        });
        peer.on('open', (id) => {
          myPeerIdDisplay.textContent = id;
          connectionStatus.textContent = 'Status: Aguardando conex√£o...';
          connectToPeer(); // Tenta conectar automaticamente ap√≥s reabrir
        });
        peer.on('error', (err) => {
          connectionStatus.textContent = `Status: Erro - ${err.type}. ${err.type === 'peer-unavailable' ? 'Verifique o Peer ID ou garanta que o amigo esteja online.' : 'Verifique a rede ou tente novamente.'}`;
          connectionStatus.classList.add('status-error');
          console.error('Erro PeerJS:', err);
        });
        peer.on('connection', (connection) => {
          conn = connection;
          setupConnection();
        });
      } else {
        connectionStatus.textContent = 'Status: Insira um Peer ID v√°lido para tentar novamente';
        connectionStatus.classList.add('status-error');
      }
    }

    // Fun√ß√£o para atualizar o status do streaming (n√£o √© progresso de download de arquivo)
    function updateStreamingStatus(text, hideAfterDelay = true) {
      const statusDiv = document.getElementById('streamingStatus');
      statusDiv.textContent = text;
      statusDiv.classList.remove('hidden');
      if (hideAfterDelay) {
        setTimeout(() => { statusDiv.classList.add('hidden'); }, 5000);
      }
    }

    // Fun√ß√£o para atualizar o progresso do download do arquivo
    function updateDownloadStatus(received, total, fileName = '') {
      const statusDiv = document.getElementById('downloadProgressStatus');
      statusDiv.classList.remove('hidden');
      if (total === 0) {
        statusDiv.textContent = '';
        statusDiv.classList.add('hidden');
        return;
      }
      const percentage = Math.min(100, Math.floor((received / total) * 100));
      let statusText = `Baixando '${fileName}': ${percentage}%`;

      if (percentage === 100) {
        statusDiv.textContent = `${statusText} - Completo!`;
        setTimeout(() => { statusDiv.classList.add('hidden'); }, 3000);
      } else {
        statusDiv.textContent = statusText;
      }
    }

    // Fun√ß√£o para exibir uma rea√ß√£o animada (AGORA DENTRO DO V√çDEO)
    function displayReaction(emoji) {
        const reactionDiv = document.createElement('div');
        reactionDiv.className = 'reaction-emoji';
        reactionDiv.textContent = emoji;

        // Calcula a posi√ß√£o aleat√≥ria dentro das dimens√µes do player de v√≠deo
        const playerRect = moviePlayer.getBoundingClientRect(); // Dimens√µes e posi√ß√£o do player em rela√ß√£o √† viewport
        // Garante que o emoji apare√ßa um pouco afastado das bordas do v√≠deo
        // 60 √© o tamanho aproximado do emoji + margem para n√£o cortar
        const x = Math.random() * (playerRect.width - 60) + 30; 
        const y = Math.random() * (playerRect.height - 60) + 30; 
        
        // Posi√ß√£o do emoji dentro do overlay (que √© absoluto em rela√ß√£o ao wrapper do v√≠deo)
        reactionDiv.style.left = `${x}px`;
        reactionDiv.style.top = `${y}px`;

        // Adiciona o emoji ao reactionOverlay que est√° dentro do video-player-wrapper
        reactionOverlay.appendChild(reactionDiv);

        // Remove o emoji ap√≥s a anima√ß√£o (2.5 segundos)
        setTimeout(() => {
            reactionDiv.remove();
        }, 2500);
    }

    // Fun√ß√£o para enviar a rea√ß√£o via PeerJS
    function sendReaction(emoji) {
        if (conn && conn.open) {
            conn.send({ type: 'reaction', emoji: emoji });
            console.log('Rea√ß√£o enviada:', emoji);
            displayReaction(emoji); // Exibe a rea√ß√£o localmente tamb√©m
        } else {
            console.warn('N√£o conectado a um peer para enviar a rea√ß√£o.');
            displayReaction(emoji); // Apenas exibe localmente se n√£o conectado
        }
    }

    // Fun√ß√£o para atualizar o √≠cone do bot√£o de play/pause no overlay
    function updateOverlayPlayPauseButtonIcon() {
        if (moviePlayer.paused) {
            overlayPlayIcon.classList.remove('hidden');
            overlayPauseIcon.classList.add('hidden');
            overlayPlayPauseButton.classList.remove('hidden'); // Mostra o bot√£o quando pausado
            overlayPlayPauseButton.classList.add('is-paused'); // Adiciona classe para estilo de pausado
            // Se pausado, o overlay e bot√µes de rea√ß√£o tamb√©m devem ser vis√≠veis
            videoOverlayControls.classList.add('show-overlay');
            reactionButtonsInVideo.classList.add('show-buttons');
        } else {
            overlayPlayIcon.classList.add('hidden');
            overlayPauseIcon.classList.remove('hidden');
            overlayPlayPauseButton.classList.add('hidden'); // Esconde o bot√£o quando est√° tocando
            overlayPlayPauseButton.classList.remove('is-paused'); // Remove classe de pausado
            // Se tocando, esconde o overlay e bot√µes de rea√ß√£o ap√≥s um tempo
            videoOverlayControls.classList.remove('show-overlay');
            reactionButtonsInVideo.classList.remove('show-buttons');
        }
    }

    // Fun√ß√£o para alternar play/pause no overlay
    function toggleOverlayPlayPause() {
        if (moviePlayer.paused) {
            moviePlayer.play();
        } else {
            moviePlayer.pause();
        }
    }

    // Fun√ß√µes para controlar a visibilidade do overlay (intera√ß√£o)
    let hideControlsTimeout;
    function showControlsTemporarily() {
        videoOverlayControls.classList.add('show-overlay');
        reactionButtonsInVideo.classList.add('show-buttons'); // Mostra bot√µes de rea√ß√£o tamb√©m
        overlayPlayPauseButton.classList.add('show-button'); // Mostra o bot√£o central temporariamente

        clearTimeout(hideControlsTimeout);
        if (!moviePlayer.paused) { // Apenas esconde se o v√≠deo estiver tocando
            hideControlsTimeout = setTimeout(() => {
                videoOverlayControls.classList.remove('show-overlay');
                reactionButtonsInVideo.classList.remove('show-buttons');
                overlayPlayPauseButton.classList.remove('show-button');
            }, 3000); // Esconde ap√≥s 3 segundos de inatividade
        }
    }

    // Fun√ß√£o para alternar entre tela cheia customizada e modo normal
    function toggleCustomFullscreen() {
        if (!isCustomFullscreen) {
            // Entra em modo de tela cheia customizada (CSS)
            videoPlayerWrapper.classList.add('custom-fullscreen');
            // Esconde os controles nativos do HTML5 video (se eles n√£o sumirem automaticamente)
            moviePlayer.removeAttribute('controls'); 
            isCustomFullscreen = true;
            customFullscreenButton.textContent = 'Shrink'; // Muda texto/√≠cone do bot√£o
            // For√ßa a exibi√ß√£o tempor√°ria dos controles customizados
            showControlsTemporarily(); 
        } else {
            // Sai do modo de tela cheia customizada
            videoPlayerWrapper.classList.remove('custom-fullscreen');
            // Mostra os controles nativos do HTML5 video novamente
            moviePlayer.setAttribute('controls', '');
            isCustomFullscreen = false;
            customFullscreenButton.textContent = '‚ÜîÔ∏è'; // Muda texto/√≠cone do bot√£o
        }
        // Re-chama a fun√ß√£o para garantir que o estado dos √≠cones seja atualizado
        updateOverlayPlayPauseButtonIcon(); 
    }


    // Configura os ouvintes de evento para a conex√£o PeerJS
    function setupConnection() {
      conn.on('open', () => {
        connectionStatus.textContent = 'Status: Conectado!';
        connectionStatus.classList.add('status-connected');
        console.log('Conex√£o PeerJS estabelecida');

        // Adiciona ouvintes de evento ao player de v√≠deo ap√≥s a conex√£o ser aberta
        moviePlayer.addEventListener('play', handlePlayerPlay);
        moviePlayer.addEventListener('pause', handlePlayerPause);
        moviePlayer.addEventListener('seeked', handlePlayerSeeked);
        
        // Adiciona ouvintes para o bot√£o de overlay play/pause
        moviePlayer.addEventListener('play', updateOverlayPlayPauseButtonIcon);
        moviePlayer.addEventListener('pause', updateOverlayPlayPauseButtonIcon);
        moviePlayer.addEventListener('loadedmetadata', updateOverlayPlayPauseButtonIcon); // Para estado inicial
        
        // Ouvintes para mostrar/esconder o overlay de controles
        videoPlayerWrapper.addEventListener('mousemove', showControlsTemporarily); // Desktop
        videoPlayerWrapper.addEventListener('touchstart', showControlsTemporarily); // Mobile
        
        updateOverlayPlayPauseButtonIcon(); // Chama para definir o estado inicial
      });

      // Lida com o recebimento de stream de m√≠dia (√°udio/v√≠deo)
      peer.on('call', (call) => {
          console.log('Recebendo chamada de v√≠deo do peer...');
          updateStreamingStatus('Recebendo streaming...');
          
          call.answer(); // Responde √† chamada de v√≠deo
          call.on('stream', (remoteStream) => {
              console.log('Stream de v√≠deo recebido do peer!');
              moviePlayer.srcObject = remoteStream; // Define o stream recebido como fonte do player
              moviePlayer.play().catch(e => console.error("Erro ao tentar tocar stream recebido:", e)); // Tenta dar play automaticamente
              updateStreamingStatus('Streaming recebido e reproduzindo!');
          });
          call.on('close', () => {
              console.log('Stream de v√≠deo encerrado.');
              updateStreamingStatus('Streaming encerrado.');
          });
      });

      conn.on('data', (data) => {
        // Lida com o in√≠cio da transfer√™ncia de arquivo para download
        if (data.type === 'file-download-start') {
          receivedFiles.set(data.fileTransferId, {
            fileName: data.fileName,
            fileType: data.fileType,
            totalChunks: data.totalChunks,
            receivedChunks: new Array(data.totalChunks), // Array para armazenar os chunks na ordem correta
            receivedSize: 0,
            fileSize: data.fileSize
          });
          console.log(`Recebendo arquivo para download: ${data.fileName} (${data.fileSize} bytes)`);
          updateDownloadStatus(0, data.fileSize, data.fileName);
        } 
        // Lida com os chunks de dados do arquivo para download
        else if (data.type === 'file-download-chunk') {
          const fileData = receivedFiles.get(data.fileTransferId);
          if (fileData) {
            fileData.receivedChunks[data.chunkIndex] = data.data; // Armazena o chunk na posi√ß√£o correta
            fileData.receivedSize += data.data.byteLength;
            updateDownloadStatus(fileData.receivedSize, fileData.fileSize, fileData.fileName);

            // Verifica se todos os chunks foram recebidos
            if (fileData.receivedSize === fileData.fileSize) {
                // Monta o arquivo completo a partir dos chunks
                const fullBlob = new Blob(fileData.receivedChunks, { type: fileData.fileType });
                const url = URL.createObjectURL(fullBlob);
                
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = fileData.fileName;
                downloadLink.textContent = `Baixar ${fileData.fileName}`;
                downloadLink.className = 'text-pink-700 underline mt-2 block';
                
                // Limpar links de download anteriores e adicionar o novo
                downloadSection.innerHTML = ''; 
                const downloadPrompt = document.createElement('p');
                downloadPrompt.className = 'text-pink-800 text-sm mt-2';
                downloadPrompt.textContent = 'Arquivo recebido para download:';
                downloadSection.appendChild(downloadPrompt);
                downloadSection.appendChild(downloadLink);

                console.log('Arquivo recebido e pronto para download:', fileData.fileName);

                receivedFiles.delete(data.fileTransferId); // Limpa o estado da transfer√™ncia
                updateDownloadStatus(fileData.fileSize, fileData.fileSize, fileData.fileName); // Garante 100%
            }
          }
        }
        // Lida com a mensagem de cancelamento de download
        else if (data.type === 'cancel-download') {
            const fileData = receivedFiles.get(data.fileTransferId);
            if (fileData) {
                receivedFiles.delete(data.fileTransferId);
                updateDownloadStatus(0, 0, ''); // Limpa o status
                console.log(`Download de arquivo '${fileData.fileName}' cancelado pelo remetente.`);
                document.getElementById('downloadProgressStatus').textContent = `Download de '${fileData.fileName}' cancelado.`;
                setTimeout(() => { document.getElementById('downloadProgressStatus').classList.add('hidden'); }, 3000);
            }
        }
        // Lida com mensagens de sincroniza√ß√£o (play, pause, seek)
        else if (data.type === 'play' || data.type === 'pause' || data.type === 'seek') {
          isSyncing = true; // Define a flag para evitar looping

          moviePlayer.currentTime = data.time;
          if (data.type === 'play') {
            moviePlayer.play();
            console.log('Sincronizar play no tempo:', data.time);
          } else if (data.type === 'pause') {
            moviePlayer.pause();
            console.log('Sincronizar pausa no tempo:', data.time);
          } else if (data.type === 'seek') {
            // O currentTime j√° foi definido, nenhuma a√ß√£o adicional √© necess√°ria para seek
            console.log('Sincronizar busca no tempo:', data.time);
          }
          // Resetar a flag ap√≥s um breve atraso para permitir que o navegador processe
          // ou imediatamente se a opera√ß√£o do player for s√≠ncrona
          setTimeout(() => { isSyncing = false; }, 100); 
        }
        // Lida com o compartilhamento de cenas
        else if (data.type === 'scene') {
          scenes = data.scenes;
          updateSceneList();
          console.log('Cenas recebidas:', data.scenes);
        }
        // Lida com a rea√ß√£o recebida
        else if (data.type === 'reaction') {
            console.log('Rea√ß√£o recebida:', data.emoji);
            displayReaction(data.emoji);
        }
      });
      conn.on('close', () => {
        connectionStatus.textContent = 'Status: Desconectado';
        connectionStatus.classList.add('status-error');
        console.log('Conex√£o PeerJS fechada');
        // Remove os ouvintes de evento quando a conex√£o √© fechada
        moviePlayer.removeEventListener('play', handlePlayerPlay);
        moviePlayer.removeEventListener('pause', handlePlayerPause);
        moviePlayer.removeEventListener('seeked', handlePlayerSeeked);
        // Remove os ouvintes do overlay de play/pause
        moviePlayer.removeEventListener('play', updateOverlayPlayPauseButtonIcon);
        moviePlayer.removeEventListener('pause', updateOverlayPlayPauseButtonIcon);
        moviePlayer.removeEventListener('loadedmetadata', updateOverlayPlayPauseButtonIcon);
        // Remove os ouvintes do wrapper do v√≠deo
        videoPlayerWrapper.removeEventListener('mousemove', showControlsTemporarily);
        videoPlayerWrapper.removeEventListener('touchstart', showControlsTemporarily);
        clearTimeout(hideControlsTimeout); // Limpa qualquer timeout pendente
      });
    }

    // Fun√ß√µes de manipulador para eventos do player de v√≠deo
    function handlePlayerPlay() {
      if (!isSyncing && conn && conn.open && currentFileUrl) {
        console.log('Enviando play sync:', moviePlayer.currentTime);
        conn.send({ type: 'play', time: moviePlayer.currentTime });
      }
    }

    function handlePlayerPause() {
      if (!isSyncing && conn && conn.open && currentFileUrl) {
        console.log('Enviando pause sync:', moviePlayer.currentTime);
        conn.send({ type: 'pause', time: moviePlayer.currentTime });
      }
    }

    function handlePlayerSeeked() {
      if (!isSyncing && conn && conn.open && currentFileUrl) {
        console.log('Enviando seek sync:', moviePlayer.currentTime);
        conn.send({ type: 'seek', time: moviePlayer.currentTime });
      }
    }

    // Fun√ß√£o para carregar e compartilhar um arquivo de v√≠deo (para streaming)
    function uploadAndShareFile() {
      const file = fileInput.files[0];
      if (!file) {
        console.warn('Nenhum arquivo selecionado para upload.');
        alert('Por favor, selecione um arquivo de v√≠deo para carregar e iniciar o streaming.');
        return;
      }
      if (!conn || !conn.open) {
        console.warn('N√£o conectado a um peer para compartilhar o v√≠deo.');
        alert('Por favor, conecte-se a um amigo antes de tentar compartilhar o v√≠deo.');
        return;
      }

      // 1. Exibir o v√≠deo imediatamente no player do remetente
      const localUrl = URL.createObjectURL(file);
      currentFileUrl = localUrl;
      movieSource.src = localUrl;
      moviePlayer.load();
      moviePlayer.classList.add('fade-in');
      
      // Link de download local para o remetente (opcional, pode ser removido se o foco for s√≥ streaming)
      const downloadLink = document.createElement('a');
      downloadLink.href = localUrl;
      downloadLink.download = file.name;
      downloadLink.textContent = `Baixar ${file.name} (Local)`;
      downloadLink.className = 'text-pink-700 underline mt-2 block';
      downloadSection.innerHTML = '';
      downloadSection.appendChild(downloadLink);
      console.log('V√≠deo carregado localmente e pronto para streaming:', file.name);

      // 2. Capturar o stream do player e envi√°-lo via PeerJS call
      updateStreamingStatus('Preparando streaming...');

      moviePlayer.oncanplay = () => {
          let stream;
          try {
              stream = moviePlayer.captureStream(); // Captura o stream de √°udio/v√≠deo do player
              console.log('Stream capturado do player:', stream);
              updateStreamingStatus('Stream capturado. Enviando...');
          } catch (error) {
              console.error('Erro ao capturar stream do player:', error);
              updateStreamingStatus('Erro ao capturar v√≠deo para streaming. Verifique as permiss√µes.');
              alert('N√£o foi poss√≠vel iniciar o streaming do v√≠deo. Por favor, verifique se o navegador permite a captura de m√≠dia do v√≠deo (geralmente exige HTTPS ou localhost).');
              return;
          }

          if (stream && conn && conn.open) {
              const call = peer.call(conn.peer, stream); // Inicia uma chamada de v√≠deo para o peer
              call.on('stream', (remoteStream) => {
                  // Este 'stream' aqui seria um stream de volta do amigo,
                  // o que n√£o √© o nosso foco principal para essa funcionalidade.
                  // Pode ser ignorado por enquanto ou usado para algo mais avan√ßado.
                  console.log('Recebido stream de volta (eco) do amigo, ou outro stream inesperado.');
              });
              call.on('close', () => {
                  console.log('Chamada de streaming encerrada.');
                  updateStreamingStatus('Streaming encerrado.');
              });
              updateStreamingStatus(`Streaming de '${file.name}' iniciado!`);
          } else {
              console.warn('N√£o foi poss√≠vel iniciar a chamada de streaming: Sem stream ou conex√£o.');
              updateStreamingStatus('Erro: N√£o foi poss√≠vel iniciar o streaming.');
          }
      };

      moviePlayer.onerror = () => {
          updateStreamingStatus('Erro ao carregar o v√≠deo localmente. Tente outro arquivo.');
          alert('Erro ao carregar o v√≠deo. Tente outro arquivo.');
          console.error('Erro ao carregar o v√≠deo localmente.');
      };
    }

    // Fun√ß√£o para enviar o arquivo completo para download (opcional)
    function shareFileForDownload() {
      const file = fileInput.files[0];
      if (!file) {
        console.warn('Nenhum arquivo selecionado para download.');
        alert('Por favor, selecione um arquivo de v√≠deo para enviar para download.');
        return;
      }
      if (!conn || !conn.open) {
        console.warn('N√£o conectado a um peer para compartilhar o arquivo para download.');
        alert('Por favor, conecte-se a um amigo antes de tentar compartilhar o v√≠deo para download.');
        return;
      }

      // Se j√° houver um FileReader ativo de um envio anterior, aborta-o
      if (currentFileReader) {
          currentFileReader.abort();
          console.log('Envio de arquivo anterior abortado para iniciar um novo.');
          updateDownloadStatus(0, 0, '');
          document.getElementById('cancelDownloadButton').classList.add('hidden');
      }

      const chunkSize = 64 * 1024; // 64 KB por chunk
      let offset = 0;
      const fileTransferId = Date.now().toString(); // ID √∫nico para esta transfer√™ncia

      const reader = new FileReader();
      currentFileReader = reader; // Armazena a refer√™ncia para o FileReader atual
      currentFileTransferId = fileTransferId; // Armazena o ID da transfer√™ncia

      document.getElementById('cancelDownloadButton').classList.remove('hidden'); // Mostra o bot√£o Cancelar

      reader.onload = function(e) {
          const arrayBuffer = e.target.result;
          const totalChunks = Math.ceil(arrayBuffer.byteLength / chunkSize);

          // Envia metadados iniciais do arquivo para download
          conn.send({
              type: 'file-download-start', // Novo tipo para download
              fileTransferId: fileTransferId,
              fileName: file.name,
              fileSize: file.size,
              fileType: file.type,
              totalChunks: totalChunks
          });
          console.log(`Iniciando envio do arquivo para download: ${file.name} (${file.size} bytes) em ${totalChunks} chunks.`);
          updateDownloadStatus(0, file.size, file.name); // Atualiza progresso de download

          // Envia os chunks do arquivo
          while (offset < arrayBuffer.byteLength) {
              const chunk = arrayBuffer.slice(offset, offset + chunkSize);
              conn.send({
                  type: 'file-download-chunk', // Novo tipo para chunks de download
                  fileTransferId: fileTransferId,
                  chunkIndex: Math.floor(offset / chunkSize),
                  data: chunk // Envia o ArrayBuffer do chunk
              });
              offset += chunkSize;
              updateDownloadStatus(offset, file.size, file.name); // Atualiza progresso de download
          }
          console.log('Finalizado envio do arquivo para download:', file.name);
          updateDownloadStatus(file.size, file.size, file.name); // Garante 100%
      };
      
      reader.onloadend = function() { // Limpa as refer√™ncias quando a leitura termina (sucesso ou aborto)
          currentFileReader = null;
          currentFileTransferId = null;
          document.getElementById('cancelDownloadButton').classList.add('hidden');
      };

      reader.readAsArrayBuffer(file); // L√™ o arquivo como ArrayBuffer
    }

    // Fun√ß√£o para cancelar o download em andamento (remetente)
    function cancelFileDownload() {
        if (currentFileReader) {
            currentFileReader.abort(); // Aborta a leitura do arquivo local
            console.log('Download de arquivo localmente cancelado (remetente).');
            updateDownloadStatus(0, 0, ''); // Limpa o status de progresso
            document.getElementById('cancelDownloadButton').classList.add('hidden'); // Esconde o bot√£o

            if (conn && conn.open && currentFileTransferId) {
                // Envia uma mensagem de cancelamento para o peer remoto
                conn.send({ type: 'cancel-download', fileTransferId: currentFileTransferId });
                console.log('Mensagem de cancelamento enviada para o peer.');
            }
            currentFileReader = null; // Limpa a refer√™ncia
            currentFileTransferId = null;
        } else {
            console.warn('Nenhum download ativo para cancelar.');
        }
    }


    // As fun√ß√µes syncPlay e syncPause agora s√£o chamadas pelos eventos do player
    // e suas chamadas diretas via bot√£o s√£o mantidas por conveni√™ncia,
    // mas a sincroniza√ß√£o principal √© via eventos.
    function syncPlay() {
      if (conn && conn.open && currentFileUrl) {
        // A√ß√£o de play √© tratada pelo evento 'play' do player
        moviePlayer.play();
      } else {
        console.warn('N√£o √© poss√≠vel sincronizar o play: n√£o conectado ou nenhum v√≠deo carregado');
        alert('Por favor, conecte-se a um amigo e carregue um v√≠deo antes de sincronizar.');
      }
    }

    function syncPause() {
      if (conn && conn.open && currentFileUrl) {
        // A√ß√£o de pause √© tratada pelo evento 'pause' do player
        moviePlayer.pause();
      } else {
        console.warn('N√£o √© poss√≠vel sincronizar a pausa: n√£o conectado ou nenhum v√≠deo carregado');
        alert('Por favor, conecte-se a um amigo e carregue um v√≠deo antes de sincronizar.');
      }
    }

    // Fun√ß√£o para adicionar uma cena (marcador de tempo)
    function addScene() {
      const time = moviePlayer.currentTime;
      const sceneName = prompt('Digite o nome da cena:') || `Cena ${scenes.length + 1}`;
      scenes.push({ name: sceneName, time: time });
      updateSceneList();
      if (conn && conn.open) {
        conn.send({ type: 'scene', scenes: scenes });
        console.log('Cena enviada:', sceneName, 'no tempo:', time);
      } else {
        console.warn('N√£o conectado a um peer para compartilhar a cena.');
        alert('Por favor, conecte-se a um amigo para compartilhar cenas.');
      }
    }

    // Fun√ß√£o para atualizar a lista de cenas no menu
    function updateSceneList() {
      sceneList.innerHTML = '';
      scenes.forEach((scene, index) => {
        const li = document.createElement('li');
        li.className = 'scene-item p-2 rounded';
        li.textContent = `${scene.name} (${formatTime(scene.time)})`;
        li.onclick = () => {
          moviePlayer.currentTime = scene.time;
          if (conn && conn.open) {
            conn.send({ type: 'play', time: scene.time }); // Envia play para sincronizar jump de cena
          }
          moviePlayer.play();
          console.log('Pulou para a cena:', scene.name, 'no tempo:', scene.time);
        };
        sceneList.appendChild(li);
      });
    }

    // Fun√ß√£o utilit√°ria para formatar o tempo em minutos:segundos
    function formatTime(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = Math.floor(seconds % 60);
      return `${min}:${sec < 10 ? '0' : ''}${sec}`;
    }

    // Efeito de fade-in para elementos com a classe 'fade-in'
    document.querySelectorAll('.fade-in').forEach(el => {
      el.style.opacity = 0;
      setTimeout(() => {
        el.style.transition = 'opacity 1s ease';
        el.style.opacity = 1;
      }, 100);
    });
  </script>
</body>
</html>
